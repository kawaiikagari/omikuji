<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>おみくじ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
@font-face {
    font-family: 'Kouzan';
    src: url('衡山毛筆フォント.ttf') format('truetype');
    font-display: swap;
}

body {
    background: #fdf9f0 url('HAIKEI.png') center center / 100% auto no-repeat fixed;
    margin: 0;
    padding: 0;
    font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
}

table.omikuji {
    width: 560px;
    height: 800px;
    max-width: 94vw;
    border: 5.6px double #c62828;
    border-radius: 21px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.35);
    background: #fffdf9 url('WASHI.png') center center / cover no-repeat;
    border-collapse: separate;
    border-spacing: 0;
    position: fixed;
    left: 20px;
    top: 20px;
    z-index: 1;
}

.jp-area {
    height: 70%;
    padding: 38px 45px 28px 50px;
    writing-mode: vertical-rl;
    text-orientation: upright;
    font-family: 'Kouzan', "Hiragino Mincho ProN", serif;
}

.jp-area h1 { font-size: 60px; margin-bottom: 4px; color: #b71c1c; letter-spacing: 0.2em; font-weight: bold; }
.jp-area h2 { font-size: 40px; margin-bottom: 16px; color: #900; letter-spacing: 0.3em; font-weight: bold; }
.jp-area > div { font-size: 25px; line-height: 1.55; letter-spacing: 0.2em; font-weight: 700; text-shadow: 1.2px 1.2px 2.5px rgba(0,0,0,0.22); }

.en-area {
    height: 36%;
    padding: 28px 48px 38px;
    background: rgba(249,246,240,0.65);
    font-family: Georgia, serif;
    font-size: 16px;
    line-height: 2.2;
}

.en strong { font-size: 26px; color:#b71c1c; font-weight: normal; }

/* 御神籤縁起リンクボタン */
.engi-button {
    position: fixed;
    left: 20px;
    top: 840px; /* おみくじ表下端に配置 */
    display: inline-block;
    background: #fffdf9 url('WASHI.png') center center / cover no-repeat;
    border: 5.6px double #c62828;
    border-radius: 21px;
    padding: 6px 12px;
    font-family: "Hiragino Mincho ProN", serif;
    font-size: 16px;
    color: #b71c1c;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 2;
    font-weight: normal; /* ボールド禁止 */
}

.engi-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.35);
}

</style>
</head>
<body>

<table class="omikuji">
    <tr>
        <td class="jp-area">
            <h1 id="rank">読み込み中…</h1>
            <h2 id="title"></h2>
            <div id="jp"></div>
        </td>
    </tr>
    <tr>
        <td class="en-area">
            <strong id="enRank"></strong> — <span id="enTitle"></span><br><br>
            <span id="enText"></span>
        </td>
    </tr>
</table>

<a href="https://kawaiikagari.github.io/omikuji/engi.html" target="_blank" class="engi-button">
    [かみやしろ神社縁起/Foundation]
</a>

<script>
const cooldown = 30 * 60 * 1000; // 30分
const lastTime = localStorage.getItem('omikuji_last');
const now = Date.now();

if (lastTime && (now - lastTime) < cooldown) {
    const wait = Math.ceil((cooldown - (now - lastTime)) / 60000);
    document.getElementById('rank').textContent = `あと ${wait} 分`;
    document.getElementById('title').textContent = '';
    document.getElementById('jp').textContent = 'おみくじは30分に1回のみ引けます';
    document.getElementById('enRank').textContent = '';
    document.getElementById('enTitle').textContent = '';
    document.getElementById('enText').textContent = 'You can draw Omikuji only once every 30 minutes';
} else {
    const randomId = Math.floor(Math.random() * 50) + 1;

    fetch('omikuji.xml')
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(str => {
            const xml = new DOMParser().parseFromString(str, "text/xml");
            const item = xml.querySelector(`omikuji[id="${randomId}"]`);
            if (!item) throw new Error('ID ' + randomId + ' なし');

            const rankEl = item.querySelector('rank');
            const rankJp = rankEl.getAttribute('jp') || rankEl.textContent.trim();
            const rankEn = rankEl.textContent.trim();

            document.getElementById('rank').textContent = rankJp;
            document.getElementById('title').textContent = item.querySelector('title_jp')?.textContent.trim() || '';
            document.getElementById('jp').textContent = item.querySelector('text_jp')?.textContent.trim() || '';
            document.getElementById('enRank').textContent = rankEn;
            document.getElementById('enTitle').textContent = item.querySelector('title_en')?.textContent.trim() || '';
            document.getElementById('enText').textContent = item.querySelector('text_en')?.textContent.trim() || '';

            localStorage.setItem('omikuji_last', Date.now());
        })
        .catch(err => {
            document.getElementById('rank').textContent = '読み込み失敗';
            document.getElementById('jp').innerHTML = 'エラー: ' + err.message;
        });
}
</script>
</body>
</html>
