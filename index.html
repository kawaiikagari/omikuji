<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>おみくじ</title>
<style>
  body { font-family: "Yu Gothic", "Hiragino Kaku Gothic Pro", Meiryo, sans-serif; background:#fff; text-align:center; padding:2em; }
  #result { margin-top:2em; font-size:1.5em; }
  button { padding:1em 2em; font-size:1em; }
</style>
</head>
<body>
<h1>おみくじを引く</h1>
<button id="drawBtn">おみくじを引く</button>
<div id="result"></div>

<script>
// XML読み込み
let xmlData;
fetch('omikuji.xml')
  .then(response => response.text())
  .then(str => (new window.DOMParser()).parseFromString(str,"text/xml"))
  .then(data => { xmlData = data; });

const rankCounts = {
  "大吉": 5,
  "中吉": 20,
  "小吉": 40,
  "吉": 34,
  "大凶": 1
};

// 100件おみくじIDを確率配列に変換
let probabilityArray = [];
for (let rank in rankCounts) {
  let count = rankCounts[rank];
  let omikujis = xmlData?.getElementsByTagName('omikuji');
  if (!omikujis) continue;
  // ランクに合致するおみくじIDを抽出
  let rankIDs = Array.from(omikujis).filter(o => o.getElementsByTagName('rank')[0].textContent === rank).map(o => parseInt(o.getAttribute('id')));
  for (let i=0; i<count; i++) {
    // もし同じランクがcountより少なければループ
    probabilityArray.push(rankIDs[i % rankIDs.length]);
  }
}

// シャッフル関数
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

document.getElementById('drawBtn').addEventListener('click', () => {
  if (!xmlData) {
    alert("XML読み込み中です。少し待ってください。");
    return;
  }

  // 配列をシャッフルしてランダムに選択
  shuffle(probabilityArray);
  let chosenID = probabilityArray[0];

  let selected = xmlData.querySelector(`omikuji[id='${chosenID}']`);
  if (!selected) {
    document.getElementById('result').innerHTML = "おみくじが取得できませんでした";
    return;
  }

  let rank = selected.getElementsByTagName('rank')[0].textContent;
  let title = selected.getElementsByTagName('title_jp')[0].textContent;
  let text = selected.getElementsByTagName('text_jp')[0].textContent;

  document.getElementById('result').innerHTML = `<strong>${rank}：${title}</strong><p>${text}</p>`;
});
</script>
</body>
</html>
