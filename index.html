<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>おみくじ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #fdf9f0 url('HAIKEI.png') center center / 100% auto no-repeat fixed;
            background-color: #fdf9f0; /* 画像なし時の代替（淡いベージュ） */
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        table.omikuji {
            width: 560px;
            height: 540px;
            max-width: 94vw;
            max-height: 88vh;
            border: 5.6px double #c62828;
            border-radius: 21px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.35);
            background: #fffdf9 url('WASHI.PNG') center center / 100% 100% no-repeat;
            background-color: #fffdf9; /* 画像なし時の代替（和紙風ベージュ） */
            position: relative;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
        }
        .jp-area {
            height: 64%;
            padding: 38px 40px 28px 48px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 17.6px;
            line-height: 2.7;
        }
        .jp-area h1 {
            font-size: 49.6px;
            margin-bottom: 18px;
            color: #b71c1c;
        }
        .jp-area h2 {
            font-size: 27.2px;
            margin-bottom: 42px;
            color: #900;
        }
        .en-area {
            height: 36%;
            padding: 28px 48px 38px;
            background: rgba(249,246,240,0.94);
            font-family: Georgia, serif;
            font-size: 13.6px;
            line-height: 1.9;
        }
        .en strong {
            font-size: 20.8px;
            color: #b71c1c;
        }
        table.omikuji::before,
        table.omikuji::after {
            content: "";
            position: absolute;
            width: 41.6px;
            height: 41.6px;
            background: #c62828;
        }
        table.omikuji::before {
            top: -20.8px;
            left: -20.8px;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
        }
        table.omikuji::after {
            bottom: -20.8px;
            right: -20.8px;
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        .footer {
            position: fixed;
            right: 30px;
            bottom: 30px;
            font-size: 16px;
            color: #555;
            background: rgba(255,255,255,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10;
            font-weight: 600;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body>

<table class="omikuji">
    <tr>
        <td class="jp-area">
            <h1 id="rank">読み込み中…</h1>
            <h2 id="title"></h2>
            <div id="jp"></div>
        </td>
    </tr>
    <tr>
        <td class="en-area">
            <strong id="enRank"></strong> — <span id="enTitle"></span><br><br>
            <span id="enText"></span>
        </td>
    </tr>
</table>

<div class="footer">第 <span id="num">?</span> 番 おみくじ</div>

<script>
    // ==================== 30分間制限（testモードで無視） ====================
    const isTestMode = location.search.includes('test');
    if (!isTestMode) {
        const lastTime = localStorage.getItem('omikuji_last');
        const now = Date.now();
        const cooldown = 30 * 60 * 1000; // 30分
        if (lastTime && (now - lastTime) < cooldown) {
            const wait = Math.ceil((cooldown - (now - lastTime)) / 60000);
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:120px; font-family:'Hiragino Mincho ProN','Yu Mincho',Georgia,serif; font-size:28px; color:#c62828; line-height:2;">
                    30分に1回しか引けません<br>
                    <span style="font-size:42px; font-weight:bold;">あと ${wait} 分</span> お待ちください
                    <hr style="border:0; border-top:3px double #c62828; width:200px; margin:40px auto;">
                    You can draw Omikuji only once every 30 minutes<br>
                    <span style="font-size:36px; font-weight:bold; color:#b71c1c;">${wait} more minute${wait > 1 ? 's' : ''}</span> please
                </div>`;
            throw new Error("30分制限中");
        }
    }

    // ==================== おみくじ読み込み（XML構造完璧対応） ====================
    const randomId = Math.floor(Math.random() * 50) + 1;

    fetch('omikuji.xml')
        .then(response => {
            if (!response.ok) {
                throw new Error(`XML読み込み失敗 (HTTP ${response.status}) - リポジトリ確認を`);
            }
            return response.text();
        })
        .then(str => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(str, "text/xml");

            // XML解析エラーチェック
            const parserError = xml.querySelector('parsererror');
            if (parserError) {
                throw new Error('XML形式エラー - omikuji.xmlを再確認');
            }

            const item = xml.querySelector(`omikuji[id="${randomId}"]`);
            if (!item) {
                throw new Error(`ID ${randomId} なし - XMLに50件あるかチェック`);
            }

            // rank抽出強化: jp属性優先（XML形式: <rank jp="大吉">Daikichi</rank>）
            const rankEl = item.querySelector('rank');
            const rankJp = rankEl ? (rankEl.getAttribute('jp') || rankEl.textContent.trim() || '不明') : '不明';
            const rankEn = rankEl ? (rankEl.textContent.trim() || 'Unknown') : 'Unknown';

            // テキスト抽出（nullセーフ）
            const titleJpEl = item.querySelector('title_jp');
            const jpTextEl = item.querySelector('text_jp');
            const titleEnEl = item.querySelector('title_en');
            const enTextEl = item.querySelector('text_en');

            const titleJp = titleJpEl ? titleJpEl.textContent.trim() : 'タイトルなし';
            const jpText = jpTextEl ? jpTextEl.textContent.trim() : '本文なし';
            const titleEn = titleEnEl ? titleEnEl.textContent.trim() : 'No Title';
            const enText = enTextEl ? enTextEl.textContent.trim() : 'No Text';

            // 表示更新
            document.getElementById('rank').textContent = rankJp;
            document.getElementById('title').textContent = titleJp;
            document.getElementById('jp').textContent = jpText;
            document.getElementById('enRank').textContent = rankEn;
            document.getElementById('enTitle').textContent = titleEn;
            document.getElementById('enText').textContent = enText;
            document.getElementById('num').textContent = randomId;

            // 制限保存
            if (!isTestMode) {
                localStorage.setItem('omikuji_last', Date.now());
            }

            console.log(`成功！ ID${randomId}: ${rankJp} - ${titleJp}`); // デバッグ用
        })
        .catch(err => {
            console.error('詳細エラー:', err); // コンソールにログ出力
            document.getElementById('rank').textContent = '読み込み失敗';
            document.getElementById('title').textContent = 'エラー詳細';
            document.getElementById('jp').innerHTML = 
                `${err.message}<br><br>` +
                '【今すぐ対処】<br>' +
                '・WASHI.PNG / HAIKEI.png を大文字/小文字厳守で再アップロード<br>' +
                '・index.html を上記コードに更新/コミット<br>' +
                '・ブラウザキャッシュクリア (Ctrl+Shift+R)<br><br>' +
                'XMLは正常なので、画像&コード更新で即解決！';
            document.getElementById('enRank').textContent = 'Error';
            document.getElementById('enTitle').textContent = '';
            document.getElementById('enText').innerHTML = 
                `${err.message}<br><br>` +
                '【Quick Fix】<br>' +
                '- Re-upload WASHI.PNG / HAIKEI.png with exact case<br>' +
                '- Update index.html with the code above & commit<br>' +
                '- Clear browser cache (Ctrl+Shift+R)<br><br>' +
                'XML is fine - this will fix it instantly!';
            document.getElementById('num').textContent = '?';
        });
</script>

</body>
</html>
