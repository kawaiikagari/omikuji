<script>
// 確率配列によるランダム抽選
fetch('omikuji.xml')
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(str => {
        const xml = new DOMParser().parseFromString(str, "text/xml");
        const items = Array.from(xml.querySelectorAll('omikuji'));
        if (!items.length) throw new Error('omikuji データなし');

        // ランク別件数に基づく確率配列作成
        const rankCounts = {
            '大吉': 5,
            '中吉': 20,
            '小吉': 40,
            '吉': 34,
            '大凶': 1
        };

        // 各ランクのオブジェクトリスト作成
        const rankMap = {};
        items.forEach(item => {
            const rankJp = item.querySelector('rank')?.getAttribute('jp') || item.querySelector('rank')?.textContent.trim();
            if (!rankMap[rankJp]) rankMap[rankJp] = [];
            rankMap[rankJp].push(item);
        });

        // 確率配列作成
        const pool = [];
        Object.keys(rankCounts).forEach(rank => {
            const candidates = rankMap[rank] || [];
            for (let i = 0; i < rankCounts[rank]; i++) {
                // candidates が空の場合はスキップ
                if (candidates.length) {
                    // ランダムに1件追加
                    const randItem = candidates[Math.floor(Math.random() * candidates.length)];
                    pool.push(randItem);
                }
            }
        });

        // 最終的にpoolからランダム抽選
        const selected = pool[Math.floor(Math.random() * pool.length)];

        const rankEl = selected.querySelector('rank');
        const rankJp = rankEl.getAttribute('jp') || rankEl.textContent.trim();
        const rankEn = rankEl.textContent.trim();

        document.getElementById('rank').textContent = rankJp;
        document.getElementById('title').textContent = selected.querySelector('title_jp')?.textContent.trim() || '';
        document.getElementById('jp').textContent = selected.querySelector('text_jp')?.textContent.trim() || '';

        document.getElementById('rank').style.fontSize = '54px';
        document.getElementById('title').style.fontSize = '36px';

        document.getElementById('enRank').textContent = rankEn;
        document.getElementById('enTitle').textContent = selected.querySelector('title_en')?.textContent.trim() || '';
        document.getElementById('enText').textContent = selected.querySelector('text_en')?.textContent.trim() || '';

        // pool内でのランダム順で番号を表示（単純1〜n表示）
        document.getElementById('num').textContent = (pool.indexOf(selected) + 1);

        if (!isTestMode) localStorage.setItem('omikuji_last', Date.now());
    })
    .catch(err => {
        document.getElementById('rank').textContent = '読み込み失敗';
        document.getElementById('jp').innerHTML = 'エラー: ' + err.message;
    });
</script>
