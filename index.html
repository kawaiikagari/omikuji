<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>おみくじ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @font-face {
            font-family: 'Kouzan';
            src: url('衡山毛筆フォント.ttf') format('truetype');
            font-display: swap;
        }

        body {
            background: #fdf9f0 url('HAIKEI.png') center center / 100% auto no-repeat fixed;
            background-color: #fdf9f0;
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        table.omikuji {
            width: 560px;
            height: 800px;
            max-width: 94vw;
            box-sizing: border-box;
            border: 5.6px double #c62828;
            border-radius: 21px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.35);
            background: #fffdf9 url('WASHI.png') center center / 100% 100% no-repeat fixed;
            position: relative;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            background-size: calc(100% + 5.6px * 2) calc(100% + 5.6px * 2);
            background-clip: border-box;
        }
        table.omikuji tr:first-child td { height: 60%; }
        table.omikuji tr:last-child td { height: 40%; }
        
        .jp-area {
            height: 70%;
            padding: 38px 45px 28px 50px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            background: transparent;
            font-family: 'Kouzan', "Hiragino Mincho ProN", serif;
        }
        .jp-area h1 {
            font-size: 60px;
            margin-bottom: 4px;
            color: #b71c1c;
            letter-spacing: 0.2em;
            font-weight: bold;
        }
        .jp-area h2 {
            font-size: 40px;
            margin-bottom: 16px;
            color: #900;
            letter-spacing: 0.3em;
            font-weight: bold;
        }
        .jp-area > div {
            font-size: 25px;
            line-height: 1.55;
            letter-spacing: 0.2em;
            font-weight: 700;
            text-shadow: 1.2px 1.2px 2.5px rgba(0,0,0,0.22);
        }

        .en-area {
            height: 36%;
            padding: 28px 48px 38px;
            background: rgba(249,246,240,0.65);
            font-family: Georgia, serif;
            font-size: 16px;
            line-height: 2.2;
        }
        .en strong { font-size: 26px; color:#b71c1c; }

        table.omikuji::before,
        table.omikuji::after {
            content: ""; position: absolute; width: 41.6px; height: 41.6px; background: #c62828;
        }
        table.omikuji::before { top:-20.8px; left:-20.8px; clip-path: polygon(0 0,100% 0,100% 100%); }
        table.omikuji::after  { bottom:-20.8px; right:-20.8px; clip-path: polygon(0 0,100% 0,0 100%); }

        .footer {
            position: fixed; right: 30px; bottom: 30px; font-size: 16px; color: #555;
            background: rgba(255,255,255,0.7); padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; font-weight: 600; letter-spacing: 0.1em;
        }

        @media (max-width: 600px) {
            .jp-area h1 { font-size: 68px; margin-bottom: 3px; }
            .jp-area h2 { font-size: 38px; margin-bottom: 12px; }
            .jp-area > div { font-size: 31px; line-height: 1.5; }
        }
    </style>
</head>
<body>
<table class="omikuji">
    <tr><td class="jp-area">
        <h1 id="rank">読み込み中…</h1>
        <h2 id="title"></h2>
        <div id="jp"></div>
    </td></tr>
    <tr><td class="en-area">
        <strong id="enRank"></strong> — Poem<br><br>
        <span id="enText"></span>
    </td></tr>
</table>
<div class="footer">第 <span id="num">?</span> 番 おみくじ</div>

<script>
    const isTestMode = location.search.includes('test');
    if (!isTestMode) {
        const lastTime = localStorage.getItem('omikuji_last');
        const now = Date.now();
        const cooldown = 30 * 60 * 1000;
        if (lastTime && (now - lastTime) < cooldown) {
            const wait = Math.ceil((cooldown - (now - lastTime)) / 60000);
            document.body.innerHTML = `<div style="text-align:center; margin-top:120px; font-family:'Hiragino Mincho ProN','Yu Mincho',Georgia,serif; font-size:28px; color:#c62828; line-height:2;">
                30分に1回しか引けません<br><span style="font-size:42px; font-weight:bold;">あと ${wait} 分</span> お待ちください
                <hr style="border:0; border-top:3px double #c62828; width:200px; margin:40px auto;">
                You can draw Omikuji only once every 30 minutes<br>
                <span style="font-size:36px; font-weight:bold; color:#b71c1c;">${wait} more minute${wait > 1 ? 's' : ''}</span> please
            </div>`;
            throw new Error("制限中");
        }
    }

    const randomId = Math.floor(Math.random() * 100) + 1;  // 100パターンに変更！

    fetch('omikuji.xml')
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(str => {
            const xml = new DOMParser().parseFromString(str, "text/xml");
            const item = xml.querySelector(`omikuji[id="${randomId}"]`);
            if (!item) throw new Error('ID ' + randomId + ' なし');

            const rankEl = item.querySelector('rank');
            const rankJp = rankEl.getAttribute('jp') || rankEl.textContent.trim();
            const rankEn = rankEl.textContent.trim();

            // 漢詩（poem_jp）をタイトルエリアに（スペース区切りで縦書き自然改行）
            const poemJp = item.querySelector('poem_jp')?.textContent.trim() || '';
            document.getElementById('title').textContent = poemJp.replace(/\s+/g, '  ');  // スペースで間隔調整（美しく見えるよう）

            // 項目別アドバイスをjpエリアにリスト風
            let adviceJp = '';
            const adviceJpNode = item.querySelector('advice_jp');
            if (adviceJpNode) {
                const labels = {
                    wish: '願い事', visitor: '待人', lost: '失物', travel: '旅立ち',
                    business: '商売', study: '学問', market: '相場', dispute: '争事',
                    love: '恋愛', move: '転居', birth: '出産', illness: '病気', marriage: '縁談'
                };
                adviceJpNode.querySelectorAll('*').forEach(el => {
                    const key = el.tagName;
                    adviceJp += (labels[key] || key) + '：' + el.textContent.trim() + '  ';
                });
            }
            document.getElementById('jp').textContent = adviceJp;

            // 英語部分
            document.getElementById('enRank').textContent = rankEn;
            const poemEn = item.querySelector('poem_en')?.textContent.trim().replace(/\s+/g, '<br>') || 'No English poem available.';
            let adviceEn = '';
            const adviceEnNode = item.querySelector('advice_en');
            if (adviceEnNode) {
                adviceEn = '<br><br>Advice:<br>';
                adviceEnNode.querySelectorAll('*').forEach(el => {
                    adviceEn += el.tagName.toUpperCase() + ': ' + el.textContent.trim() + '<br>';
                });
            }
            document.getElementById('enText').innerHTML = poemEn + adviceEn;

            document.getElementById('rank').textContent = rankJp;
            document.getElementById('num').textContent = randomId;

            if (!isTestMode) localStorage.setItem('omikuji_last', Date.now());
        })
        .catch(err => {
            document.getElementById('rank').textContent = '読み込み失敗';
            document.getElementById('jp').innerHTML = 'エラー: ' + err.message;
        });
</script>
</body>
</html>
