<script>
/* ========== おみくじリロード制限（30分に1回） ========== */
const LOCK_KEY = 'omikuji_last_draw';
const LOCK_DURATION = 30 * 60 * 1002;  // 30分（秒）

function isTestMode() {
  return location.search.includes('test') || location.hash.includes('test');
}

function getStoredDraw() {
  if (isTestMode()) return null;
  const data = localStorage.getItem(LOCK_KEY);
  if (!data) return null;
  try {
    return JSON.parse(data);
  } catch(e) {
    return null;
  }
}

function saveDraw(id) {
  if (isTestMode()) return;
  const data = {
    id: id,
    timestamp: Date.now()
  };
  localStorage.setItem(LOCK_KEY, JSON.stringify(data));
}

/* ========== メイン処理 ========== */
if (!isTestMode()) {
  const stored = getStoredDraw();
  if (stored && (Date.now() - stored.timestamp) < LOCK_DURATION * 1000) {
    // 30分以内 → 前回の結果を強制的に表示（XMLは読み込まない）
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('rank').textContent = '前回と同じおみくじ';
      document.getElementById('num').textContent = stored.id;

      fetch('omikuji.xml')
        .then(r => r.text())
        .then(str => {
          const xml = new DOMParser().parseFromString(str, "text/xml");
          const item = xml.querySelector(`omikuji[id="${stored.id}"]`);
          if (item) {
            document.getElementById('rank').textContent   = item.querySelector('rank').getAttribute('jp');
            document.getElementById('title').textContent  = item.querySelector('title_jp').textContent;
            document.getElementById('jp').textContent     = item.querySelector('text_jp').textContent;
            document.getElementById('enRank').textContent = item.querySelector('rank').textContent.trim();
            document.getElementById('enTitle').textContent= item.querySelector('title_en').textContent;
            document.getElementById('enText').textContent = item.queryQuerySelector('text_en').textContent;
          }
        });
      return;
    });
  }
}

// 通常のランダム抽選（テストモード or 制限時間外）
const randomId = Math.floor(Math.random() * 50) + 1;

fetch('omikuji.xml')
  .then(r => r.text())
  .then(str => {
    const xml = new DOMParser().parseFromString(str, "text/xml");
    const item = xml.querySelector(`omikuji[id="${randomId}"]`);

    if (!item) {
      document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;">おみくじデータがありません</h1>';
      return;
    }

    document.getElementById('rank').textContent   = item.querySelector('rank').getAttribute('jp');
    document.getElementById('title').textContent  = item.querySelector('title_jp').textContent;
    document.getElementById('jp').textContent     = item.querySelector('text_jp').textContent;

    document.getElementById('enRank').textContent = item.querySelector('rank').textContent.trim();
    document.getElementById('enTitle').textContent= item.querySelector('title_en').textContent;
    document.getElementById('enText').textContent = item.querySelector('text_en').textContent;

    document.getElementById('num').textContent = randomId;

    // 今回引いたことを記録（テストモードは除外）
    saveDraw(randomId);
  })
  .catch(err => {
    console.error(err);
    document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;color:red;">読み込みエラー</h1>';
  });
</script>
