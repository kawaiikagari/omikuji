<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>おみくじ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ここは従来のCSSのまま省略 */
</style>
</head>
<body>
<table class="omikuji">
    <tr><td class="jp-area">
        <h1 id="rank">読み込み中…</h1>
        <h2 id="title"></h2>
        <div id="jp"></div>
    </td></tr>
    <tr><td class="en-area">
        <strong id="enRank"></strong> — <span id="enTitle"></span><br><br>
        <span id="enText"></span>
    </td></tr>
</table>

<div class="footer">第 <span id="num">?</span> 番 おみくじ</div>
<a class="link-btn" href="https://kawaiikagari.github.io/omikuji/engi.html" target="_blank">かみやしろ神社</a>

<script>
const isTestMode = location.search.includes('test');

// --- 引く回数制限 ---
if (!isTestMode) {
    const lastTime = localStorage.getItem('omikuji_last');
    const now = Date.now();
    const cooldown = 30 * 60 * 1000;
    if (lastTime && (now - lastTime) < cooldown) {
        const wait = Math.ceil((cooldown - (now - lastTime)) / 60000);
        document.querySelector('table.omikuji').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '50%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
        overlay.style.textAlign = 'center';
        overlay.style.fontFamily = "'Hiragino Mincho ProN','Yu Mincho',Georgia,serif";
        overlay.style.fontSize = '28px';
        overlay.style.color = '#c62828';
        overlay.style.lineHeight = '2';
        overlay.style.zIndex = '30';
        overlay.innerHTML = `
            30分に1回しか引けません<br>
            <span style="font-size:42px; font-weight:bold;">あと ${wait} 分</span> お待ちください
            <hr style="border:0; border-top:3px double #c62828; width:200px; margin:40px auto;">
            You can draw Omikuji only once every 30 minutes<br>
            <span style="font-size:36px; font-weight:bold; color:#b71c1c;">${wait} more minute${wait > 1 ? 's' : ''}</span> please
        `;
        document.body.appendChild(overlay);
        throw new Error("制限中");
    }
}

// --- 確率配列方式 ---
// ランクごとにidを配列に入れる（例）
const probabilityArray = [
    1,1,1,1,1,             // 大吉 5% (id 1-5)
    6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25, // 中吉 20% (id 6-25)
    26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,50, // 小吉 30% (id 26-55)
    46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100 // 凶 45%
];

// 配列からランダムで1つ選ぶ
const randomId = probabilityArray[Math.floor(Math.random() * probabilityArray.length)];

fetch('omikuji.xml')
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(str => {
        const xml = new DOMParser().parseFromString(str, "text/xml");
        const item = xml.querySelector(`omikuji[id="${randomId}"]`);
        if (!item) throw new Error('ID ' + randomId + ' なし');

        const rankEl = item.querySelector('rank');
        const rankJp = rankEl.getAttribute('jp') || rankEl.textContent.trim();
        const rankEn = rankEl.textContent.trim();

        document.getElementById('rank').textContent = rankJp;
        document.getElementById('title').textContent = item.querySelector('title_jp')?.textContent.trim() || '';
        document.getElementById('jp').textContent = item.querySelector('text_jp')?.textContent.trim() || '';

        document.getElementById('rank').style.fontSize = '54px';
        document.getElementById('title').style.fontSize = '36px';

        document.getElementById('enRank').textContent = rankEn;
        document.getElementById('enTitle').textContent = item.querySelector('title_en')?.textContent.trim() || '';
        document.getElementById('enText').textContent = item.querySelector('text_en')?.textContent.trim() || '';
        document.getElementById('num').textContent = randomId;

        if (!isTestMode) localStorage.setItem('omikuji_last', Date.now());
    })
    .catch(err => {
        document.getElementById('rank').textContent = '読み込み失敗';
        document.getElementById('jp').innerHTML = 'エラー: ' + err.message;
    });
</script>
</body>
</html>
