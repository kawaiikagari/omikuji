<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>おみくじ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #fdf9f0 url('HAIKEI.png') center center / 100% auto no-repeat fixed;
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        table.omikuji {
            width: 560px;
            height: 540px;
            max-width: 94vw;
            max-height: 88vh;
            border: 5.6px double #c62828;
            border-radius: 21px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.35);
            background: #fffdf9 url('WASHI.PNG') center center / 100% 100% no-repeat;
            position: relative;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
        }
        .jp-area {
            height: 64%;
            padding: 38px 40px 28px 48px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 17.6px;
            line-height: 2.7;
        }
        .jp-area h1 {
            font-size: 49.6px;
            margin-bottom: 18px;
            color: #b71c1c;
        }
        .jp-area h2 {
            font-size: 27.2px;
            margin-bottom: 42px;
            color: #900;
        }
        .en-area {
            height: 36%;
            padding: 28px 48px 38px;
            background: rgba(249,246,240,0.94);
            font-family: Georgia, serif;
            font-size: 13.6px;
            line-height: 1.9;
        }
        .en strong {
            font-size: 20.8px;
            color: #b71c1c;
        }
        table.omikuji::before,
        table.omikuji::after {
            content: "";
            position: absolute;
            width: 41.6px;
            height: 41.6px;
            background: #c62828;
        }
        table.omikuji::before {
            top: -20.8px;
            left: -20.8px;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
        }
        table.omikuji::after {
            bottom: -20.8px;
            right: -20.8px;
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        .footer {
            position: fixed;
            right: 30px;
            bottom: 30px;
            font-size: 16px;
            color: #555;
            background: rgba(255,255,255,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10;
            font-weight: 600;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body>

<table class="omikuji">
    <tr>
        <td class="jp-area">
            <h1 id="rank">読み込み中…</h1>
            <h2 id="title"></h2>
            <div id="jp"></div>
        </td>
    </tr>
    <tr>
        <td class="en-area">
            <strong id="enRank"></strong> — <span id="enTitle"></span><br><br>
            <span id="enText"></span>
        </td>
    </tr>
</table>

<div class="footer">第 <span id="num">?</span> 番 おみくじ</div>

<script>
    // ==================== 30分間制限（testモードで無視） ====================
    const isTestMode = location.search.includes('test');
    if (!isTestMode) {
        const lastTime = localStorage.getItem('omikuji_last');
        const now = Date.now();
        const cooldown = 30 * 60 * 1000; // 30分
        if (lastTime && (now - lastTime) < cooldown) {
            const wait = Math.ceil((cooldown - (now - lastTime)) / 60000);
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:120px; font-family:'Hiragino Mincho ProN','Yu Mincho',Georgia,serif; font-size:28px; color:#c62828; line-height:2;">
                    30分に1回しか引けません<br>
                    <span style="font-size:42px; font-weight:bold;">あと ${wait} 分</span> お待ちください
                    <hr style="border:0; border-top:3px double #c62828; width:200px; margin:40px auto;">
                    You can draw Omikuji only once every 30 minutes<br>
                    <span style="font-size:36px; font-weight:bold; color:#b71c1c;">${wait} more minute${wait > 1 ? 's' : ''}</span> please
                </div>`;
            throw new Error("30分制限中");
        }
    }

    // ==================== おみくじ読み込み ====================
    const randomId = Math.floor(Math.random() * 50) + 1;

    fetch('./omikuji.xml')
        .then(response => {
            if (!response.ok) {
                throw new Error(`XMLファイルの読み込みに失敗しました (HTTP ${response.status})`);
            }
            return response.text();
        })
        .then(str => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(str, "text/xml");

            // XML解析エラーのチェック
            const parserError = xml.querySelector('parsererror');
            if (parserError) {
                throw new Error('XMLファイルの形式が不正です');
            }

            const item = xml.querySelector(`omikuji[id="${randomId}"]`);
            if (!item) {
                throw new Error(`ID ${randomId} のおみくじが見つかりません`);
            }

            // 内容を反映
            document.getElementById('rank').textContent = item.querySelector('rank').getAttribute('jp');
            document.getElementById('title').textContent = item.querySelector('title_jp').textContent;
            document.getElementById('jp').textContent = item.querySelector('text_jp').textContent;
            document.getElementById('enRank').textContent = item.querySelector('rank').textContent.trim();
            document.getElementById('enTitle').textContent = item.querySelector('title_en').textContent;
            document.getElementById('enText').textContent = item.querySelector('text_en').textContent;
            document.getElementById('num').textContent = randomId;

            // 最終引いた時間を保存
            if (!isTestMode) {
                localStorage.setItem('omikuji_last', Date.now());
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('rank').textContent = '読み込み失敗';
            document.getElementById('title').textContent = 'エラー';
            document.getElementById('jp').innerHTML = 
                'おみくじデータの読み込みに失敗しました。<br><br>' +
                '【よくある原因】<br>' +
                '・Firefoxでローカルファイル（file://）として開いている<br>' +
                '→ GitHub PagesのURL（https://）からアクセスしてください<br><br>' +
                '・omikuji.xml が正しく配置されていない';
            document.getElementById('enText').textContent = 
                'Failed to load Omikuji data.\n\n' +
                'Common cause:\n' +
                '- Opening this file locally in Firefox (file:// protocol)\n' +
                '→ Please access via GitHub Pages URL (https://)';
        });
</script>

</body>
</html>
